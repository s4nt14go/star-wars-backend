name: local action

inputs:
  AWS_ACCESS_KEY_ID:
    required: true
  AWS_SECRET_ACCESS_KEY:
    required: true
  DEPLOYMENT_ACCOUNT:
    required: true

runs:
  using: "composite"

  steps:
    - uses: actions/checkout@v2
    - uses: actions/setup-python@v2
      with:
        python-version: '3.x'
    - uses: actions/setup-node@v1
      with:
        node-version: '12'

    - name: npm ci
      shell: bash
      run: npm ci

    - name: set credentials
      shell: bash
      run: |
        export AWS_REGION=us-east-1
        export AWS_ACCESS_KEY_ID=${{ inputs.AWS_ACCESS_KEY_ID }}
        export AWS_SECRET_ACCESS_KEY=${{ inputs.AWS_SECRET_ACCESS_KEY }}
        export AWS_SESSION_TOKEN=${{ inputs. }}
        CREDS=`aws sts assume-role --role-arn arn:aws:iam::${{ inputs.DEPLOYMENT_ACCOUNT }}:role/ci-role --role-session-name=ci_user`
        export AWS_ACCESS_KEY_ID=`echo $CREDS | jq -r '.Credentials.AccessKeyId'`
        export AWS_SECRET_ACCESS_KEY=`echo $CREDS | jq -r '.Credentials.SecretAccessKey'`
        export AWS_SESSION_TOKEN=`echo $CREDS | jq -r '.Credentials.SessionToken'`
